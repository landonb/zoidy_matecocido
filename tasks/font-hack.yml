---

# REPLICA/2019-03-14: [zoidy_matecocido|zoidy_apps_et_al]/tasks/font-hack.yml

# *** Local variables (Facts).

- set_fact:
    HACK_VERS_MAJOR: 'v3'
    HACK_VERS_MINOR: '003'

- set_fact:
    HACK_VERS: "{{ HACK_VERS_MAJOR }}.{{ HACK_VERS_MINOR }}"

- set_fact:
    HACK_FILE: "Hack-{{ HACK_VERS }}-ttf"

# *** Alert user if newer version.

- name: 'Ensure ‘jq’ is available'
  # SAVVY/2023-04-20: `command` is not found by 'command' module,
  # because it's a shell construct. I.e., cannot call:
  #   ansible.builtin.command: "command -v jq"
  ansible.builtin.shell: "command -v jq"

# SAVVY/2023-04-20 18:39: Still v3.003. (I don't really expect this to ever change.)
- name: Check for new version of Hack.
  ansible.builtin.shell: "curl -s https://api.github.com/repos/source-foundry/Hack/releases/latest | jq -r '.tag_name'"
  register: LATEST_VERSION

- debug: msg="Latest HACK∷ {{ LATEST_VERSION.stdout }}"

- fail: msg="Update HACK! / Latest∷ {{ LATEST_VERSION.stdout }} / Current∷ {{ HACK_VERS }}"
  when: HACK_VERS != LATEST_VERSION.stdout

# *** Do the work.

- name: Ensure ~/.downloads directory exists
  file: path={{ zoidy_homefries_downloads_dir }} state=directory
  tags: always

- name: Fetch the Hack font release, if not previously downloaded
  get_url:
    url: "https://github.com/source-foundry/Hack/releases/download/{{ HACK_VERS }}/{{ HACK_FILE }}.zip"
    dest: "{{ zoidy_homefries_downloads_dir }}/"

- name: Ensure user home font directory directory exists
  file: path="{{ ansible_env.HOME }}/.fonts/{{ HACK_FILE }}/" state=directory

- name: Unarchive the Hack font release archive (Install Font- HACK!)
  unarchive:
    src: "{{ zoidy_homefries_downloads_dir }}/{{ HACK_FILE }}.zip"
    dest: "{{ ansible_env.HOME }}/.fonts/{{ HACK_FILE }}/"
    remote_src: yes
  notify: Build font information cache files

